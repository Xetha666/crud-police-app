---
import Filters from "@/components/Filters.astro";

---
<div class="p-4">
    <div class="flex justify-end gap-2 mb-4">
      <Filters/>
      <button class="btn btn-success text-white shadow-lg animate-fade-in-left" onclick="prepararNuevoRegistro(); add_modal.showModal()">
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        AGREGAR PERSONAL
      </button>
    </div>

    <div class="overflow-x-auto rounded-box border border-white bg-base-200 shadow-xl animate-fade-in"></div>
</div>

<dialog id="add_modal" class="modal backdrop:backdrop-blur-md">
  <div class="modal-box w-11/12 max-w-[95vw] h-[90vh] bg-base-200 border border-white p-0 flex flex-col overflow-hidden">
    <div class="bg-neutral p-4 text-neutral-content flex justify-between items-center border-b border-white sticky top-0 z-20">
      <h3 class="font-bold text-xl uppercase">Ficha Integral de Registro de Personal</h3>
      <button class="btn btn-circle btn-ghost btn-sm" onclick="add_modal.close()">✕</button>
    </div>
    
    <form id="form_personal" class="m-6 overflow-y-auto">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="flex flex-col gap-3">
          <h4 class="font-bold text-primary border-b border-primary/40 text-xs">I. IDENTIDAD Y GRADO</h4>          
          <input type="file" name="foto" class="file-input file-input-bordered file-input-xs w-full" accept="image/*" />
          <p class="text-[10px] uppercase font-bold opacity-50 text-center">Foto Actual</p>
          <img 
            id="modal_preview_foto" 
            src="" 
            class="w-11/12 h-40 object-cover rounded-lg border-2 border-primary/20 shadow-md hidden mx-auto" 
            alt="Vista previa edición"
          />
          <input type="text" name="sub_unidad_situacion" placeholder="SUB UNIDAD / SITUACIÓN" class="input input-bordered input-xs w-full" />
          <input type="text" name="sede_depincri" placeholder="SEDE DEPINCRI" class="input input-bordered input-xs w-full" />
          <input type="text" name="area_oficina" placeholder="AREA Y/U OFICINA" class="input input-bordered input-xs w-full" />
          <input type="text" name="grado" placeholder="GRADO" class="input input-bordered input-xs w-full" />
          <input type="text" name="apellidos_nombres" placeholder="APELLIDOS Y NOMBRES" class="input input-bordered input-xs w-full font-bold" />
          <input type="text" name="sexo" placeholder="SEXO" class="input input-bordered input-xs w-full font-bold" />
          
          <div class="p-2 rounded-lg border border-white/10 bg-base-100/50">
            <p class="text-[9px] font-black opacity-60 mb-2 uppercase">NATURALEZA</p>
            <div class="flex flex-col gap-1">
                <input type="text" name="distrito_nac" placeholder="Distrito" class="input input-bordered input-xs" />
                <input type="text" name="provincia_nac" placeholder="Provincia" class="input input-bordered input-xs" />
                <input type="text" name="depto_nac" placeholder="Depto." class="input input-bordered input-xs" />
            </div>
          </div>
          <div class="flex gap-2">
            <input type="date" name="fecha_nac" class="input input-bordered input-xs flex-1" title="Fecha Nac." />
            <input type="number" name="edad" placeholder="EDAD" class="input input-bordered input-xs w-20" />
          </div>
        </div>

        <div class="flex flex-col gap-3 bg-base-300/10 p-2 rounded-xl border border-white/5 h-fit lg:col-span-2">
          <h4 class="font-bold text-primary border-b border-primary/40 text-xs">II. INFORMACIÓN PNP</h4>
          <div class="flex gap-1">
            <input type="text" name="dni" placeholder="DNI" class="input input-bordered input-xs w-1/2" maxlength="8" />
            <input type="text" name="codigo_dni" placeholder="COD DNI" class="input input-bordered input-xs w-1/2" />
          </div>
          <div class="grid grid-cols-2 gap-2">
            <input type="date" name="ingreso_pnp" class="input input-bordered input-xs" title="Ingreso PNP" />
            <input type="date" name="egreso_pnp" class="input input-bordered input-xs" title="Egreso PNP" />
          </div>
          <div class="p-2 rounded-lg border border-white/10 bg-base-100/50">
            <p class="text-[9px] font-black opacity-60 mb-2">TIEMPO SERVICIO (Reales y Efectivos)</p>
            <div class="grid grid-cols-3 gap-1">
                <input type="text" name="tiempo_servicio_anios" placeholder="AÑOS" class="input input-bordered input-xs" readonly />
                <input type="text" name="tiempo_servicio_meses" placeholder="MES" class="input input-bordered input-xs" readonly />
                <input type="text" name="tiempo_servicio_dias" placeholder="DIAS" class="input input-bordered input-xs" readonly />
            </div>
          </div>
          <input type="text" name="codigo_especialidad" placeholder="CODIGO y/o ESPECIALIDAD" class="input input-bordered input-xs" />
          <div class="p-2 rounded-lg border border-white/10 bg-base-100/50">
            <p class="text-[9px] font-black opacity-60 mb-2 uppercase">CARNET DE IDENTIDAD PERSONAL (CIP)</p>
            <div class="grid grid-cols-2 gap-1 mb-2">
              <input type="text" name="cip_antiguo_codofin" placeholder="ANTIGUO y/o CODOFÍN" class="input input-bordered input-xs mb-1" />
              <input type="text" name="cip_numero" placeholder="N° CIP" class="input input-bordered input-xs mb-1" />
              <input type="text" name="cip_situacion" placeholder="SIT CIP" class="input input-bordered input-xs mb-1" />
              <input type="date" name="cip_fecha_expedicion" class="input input-bordered input-xs" title="FECHA (Expedición y/o Pérdida)" />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <input type="date" title="Ultimo Ascenso" name="ultimo_ascenso" placeholder="ULTIMO ASCENSO" class="input input-bordered input-xs" />
            <input type="date" title="Ultimo Incorporacion DIVPOL CHYO" name="incorp_divpol_chyo" placeholder="INCORP. DIVPOL-CHYO" class="input input-bordered input-xs"/>
            <input type="text" name="grupo_sanguineo" placeholder="GRUPO SANG." class="input input-bordered input-xs" />
            <input type="date" title="Incorporacion Depincri" name="incorp_depincri" placeholder="INCORP. DEPINCRI" class="input input-bordered input-xs" />
            <input type="text" name="cargo" placeholder="CARGO" class="input input-bordered input-xs" />
            <input type="text" name="codigo_cargo" placeholder="COD. CARGO" class="input input-bordered input-xs" />
            <input type="text" name="funcion_horario" placeholder="FUNCION Y HORARIO" class="input input-bordered input-xs" />
            <select name="aptitud_psicosomatica" class="select select-bordered select-xs w-full min-h-6">
                <option disabled selected value="">APTITUD PSICOSOM.</option>
                <option value="APTO">APTO</option>
                <option value="NO APTO">NO APTO</option>
                <option value="RESTRINGIDO">RESTRINGIDO</option>
            </select>
            <input type="text" name="procedencia" placeholder="PROCEDENCIA" class="input input-bordered input-xs" />
            <input type="text" name="calidad_incorporacion" placeholder="SE INCORPORA AL DEPINCRI EN CALIDAD DE" class="input input-bordered input-xs" />
          </div>
        </div>

        <div class="flex flex-col gap-3">
          <h4 class="font-bold text-primary border-b border-primary/40 text-xs">III. ARMAMENTO PARTICULAR Y ESTADO</h4>
          <div class="grid grid-cols-1 gap-4">
            <div class="p-2 rounded-lg border border-warning/20 bg-warning/5">
              <p class="text-[9px] font-black text-warning mb-2 uppercase">PARTICULAR</p>
              <div class="grid grid-cols-2 gap-1 mb-2">
                <input type="text" name="arma_part_tipo" placeholder="TIPO" class="input input-bordered input-xs" />
                <input type="text" name="arma_part_marca" placeholder="MARCA" class="input input-bordered input-xs" />
                <input type="text" name="arma_part_modelo" placeholder="MODELO" class="input input-bordered input-xs" />
                <input type="text" name="arma_part_calibre" placeholder="CALIBRE" class="input input-bordered input-xs" />
              </div>
              <input type="text" name="arma_part_serie" placeholder="N° SERIE" class="input input-bordered input-xs mb-2" />              

              <div class="p-2 rounded-lg border border-white/10 bg-base-100/50">
                <p class="text-[9px] font-black text-warning mb-2 uppercase">CERTIFICADO DE ARMA DE FUEGO (CAF)</p>
                <input type="text" name="arma_part_caf_num" placeholder="N° CAF" class="input input-bordered input-xs my-2" />
                <p class="text-[9px] font-black opacity-60 mb-2 uppercase">FECHA</p>

                <div class="grid grid-cols-2 gap-1 mb-2">
                  <input type="date" name="arma_part_caf_exped" class="input input-bordered input-xs" title="Expedic." />
                  <input type="date" name="arma_part_caf_caduca" class="input input-bordered input-xs" title="Caduca" />
                  <input type="text" name="arma_part_caf_libro" placeholder="LIBRO" class="input input-bordered input-xs" />                
                  <input type="text" name="arma_part_caf_folio" placeholder="FOLIO" class="input input-bordered input-xs" />
                </div>
              
                <p class="text-[9px] font-black opacity-60 mb-2 uppercase">TARJETA PROPIEDAD ARMA DE FUEGO</p>
                <div class="grid grid-cols-2 gap-1 mb-2">
                  <input type="text" name="arma_part_tarjeta_num" placeholder="N° TARJETA" class="input input-bordered input-xs" />
                  <input type="date" name="arma_part_tarjeta_emision" class="input input-bordered input-xs" title="Fecha Emisión" />
                </div>
              </div>
              
            </div>
            <div class="p-2 rounded-lg border border-info/20 bg-info/5">
              <p class="text-[9px] font-black text-info mb-2 uppercase">ESTADO</p>
              <div class="grid grid-cols-2 gap-1 mb-2">
                <input type="text" name="arma_est_tipo" placeholder="TIPO" class="input input-bordered input-xs" />
                <input type="text" name="arma_est_marca" placeholder="MARCA" class="input input-bordered input-xs" />
                <input type="text" name="arma_est_modelo" placeholder="MODELO" class="input input-bordered input-xs" />
                <input type="text" name="arma_est_calibre" placeholder="CALIBRE" class="input input-bordered input-xs" />
              </div>
              <input type="text" name="arma_est_serie" placeholder="N° SERIE" class="input input-bordered input-xs mb-2" />
                <div class="p-2 rounded-lg border border-white/10 bg-base-100/50">
                  <p class="text-[9px] font-black text-info mb-2 uppercase">CERTIFICADO DE ARMA DE FUEGO (CAF)</p>
                  <input type="text" name="arma_est_caf_num" placeholder="N° CAF" class="input input-bordered input-xs my-2" />
                  <p class="text-[9px] font-black opacity-60 mb-2 uppercase">FECHA</p>

                  <div class="grid grid-cols-2 gap-1 mb-2">
                    <input type="date" name="arma_est_caf_exped" class="input input-bordered input-xs" title="Expedic." />
                    <input type="date" name="arma_est_caf_caduca" class="input input-bordered input-xs" title="Caduca" />
                    <input type="text" name="arma_est_caf_libro" placeholder="LIBRO" class="input input-bordered input-xs" />                
                    <input type="text" name="arma_est_caf_folio" placeholder="FOLIO" class="input input-bordered input-xs" />
                  </div>
                
                  <p class="text-[9px] font-black opacity-60 mb-2 uppercase">TARJETA PROPIEDAD ARMA DE FUEGO</p>
                  <div class="grid grid-cols-2 gap-1 mb-2">
                    <input type="text" name="arma_est_tarjeta_num" placeholder="N° TARJETA" class="input input-bordered input-xs" />
                    <input type="date" name="arma_est_tarjeta_emision" class="input input-bordered input-xs" title="Fecha Emisión" />
                  </div>
                </div>
            </div>
          </div>
          
        </div>

        <div class="flex flex-col gap-3">
          <h4 class="font-bold text-primary border-b border-primary/40 text-xs">IV. LICENCIAS DE CONDUCIR</h4>
          <div class="p-2 rounded-lg border border-white/10 bg-base-100/50">
            <p class="text-[9px] font-black opacity-60 mb-2 uppercase">VEHICULO MAYOR (CAMIONETA Y/O AUTO)</p>
            <div class="grid grid-cols-3 gap-1 mb-2">
                <input type="text" name="lic_mayor_particular" placeholder="PARTICULAR" class="input input-bordered input-xs" />
                <input type="text" name="lic_mayor_policial" placeholder="POLICIAL" class="input input-bordered input-xs" />
                <input type="text" name="lic_mayor_militar" placeholder="MILITAR" class="input input-bordered input-xs" />
            </div>
            <div class="grid grid-cols-2 gap-1">
                <input type="text" name="lic_mayor_clase" placeholder="CLASE" class="input input-bordered input-xs" />
                <input type="text" name="lic_mayor_categoria" placeholder="CATEGORIA" class="input input-bordered input-xs" />
                <input type="date" name="lic_mayor_f_exped" title="F.EXPED" class="input input-bordered input-xs" />
                <input type="date" name="lic_mayor_f_caduc" title="F.CADUC" class="input input-bordered input-xs" />
            </div>
          </div>
          <div class="p-2 rounded-lg border border-white/10 bg-base-100/50">
            <p class="text-[9px] font-black opacity-60 mb-2 uppercase">VEHICULO MENOR (MOTOCICLETA)</p>
            <div class="grid grid-cols-3 gap-1 mb-2">
                <input type="text" name="lic_menor_particular" placeholder="PARTICULAR" class="input input-bordered input-xs" />
                <input type="text" name="lic_menor_policial" placeholder="POLICIAL" class="input input-bordered input-xs" />
                <input type="text" name="lic_menor_militar" placeholder="MILITAR" class="input input-bordered input-xs" />
            </div>
            <div class="grid grid-cols-2 gap-1">
                <input type="text" name="lic_menor_clase" placeholder="CLASE" class="input input-bordered input-xs" />
                <input type="text" name="lic_menor_categoria" placeholder="CATEGORIA" class="input input-bordered input-xs" />
                <input type="date" name="lic_menor_f_exped" title="F.EXPED" class="input input-bordered input-xs" />
                <input type="date" name="lic_menor_f_caduc" title="F.CADUC" class="input input-bordered input-xs" />
            </div>
          </div>
        </div>

        <div class="flex flex-col gap-3">
          <h4 class="font-bold text-primary border-b border-primary/40 text-xs">V. DOMICILIO Y ECONOMÍA</h4>
          <input type="text" name="estado_civil" placeholder="ESTADO CIVIL (EC)" class="input input-bordered input-xs" />
          <div class="p-2 rounded-lg border border-white/10 bg-base-100/50">
            <p class="text-[9px] font-black opacity-60 mb-2 uppercase">DOMICILIO</p>
            <input type="text" name="direccion" placeholder="DIRECCIÓN" class="input input-bordered input-xs mb-1" />
            <input type="text" name="referencia_domiciliaria" placeholder="REFERENCIA DOMICILIARIA" class="input input-bordered input-xs mb-1" />
            <div class="grid grid-cols-3 gap-1">
                <input type="text" name="distrito_dom" placeholder="Distrito" class="input input-bordered input-xs" />
                <input type="text" name="provincia_dom" placeholder="Provincia" class="input input-bordered input-xs" />
                <input type="text" name="depto_dom" placeholder="Departamento" class="input input-bordered input-xs" />
            </div>
          </div>
          <div class="p-2 rounded-lg border border-success/30 bg-success/5">
            <p class="text-[9px] font-black text-success mb-2 uppercase">BANCO DE LA NACIÓN</p>
            <input type="text" name="bn_cuenta_corriente" placeholder="N° CUENTA" class="input input-bordered input-xs mb-1" />
            <input type="text" name="bn_cci" placeholder="C.C.I" class="input input-bordered input-xs" />
          </div>
        </div>

        <div class="lg:col-span-2 flex flex-col gap-3">
          <h4 class="font-bold text-primary border-b border-primary/40 text-xs">VI. COMUNICACIONES Y REASIGNACIÓN</h4>
          <div class="grid grid-cols-2 gap-4">
             <div class="p-2 rounded-lg border border-white/10 bg-base-100/50">
                <p class="text-[9px] font-black opacity-60 mb-2 uppercase">CORREO (PARTICULAR)</p>
                <div class="grid grid-cols-2 gap-1 mb-1">
                    <input type="email" name="email_gmail" placeholder="GMAIL" class="input input-bordered input-xs" />
                    <input type="email" name="email_hotmail" placeholder="HOTMAIL" class="input input-bordered input-xs" />
                </div>
                <input type="email" name="email_institucional" placeholder="INSTITUCIONAL" class="input input-bordered input-xs" />
             </div>
             <div class="p-2 rounded-lg border border-white/10 bg-base-100/50">
                <p class="text-[9px] font-black opacity-60 mb-2 uppercase">CELULAR</p>
                <div class="grid grid-cols-5 gap-1">
                    <input type="text" name="telf_rpc" placeholder="RPC" class="input input-bordered input-xs" />
                    <input type="text" name="telf_rpm" placeholder="RPM" class="input input-bordered input-xs" />
                    <input type="text" name="telf_entel" placeholder="ENTEL" class="input input-bordered input-xs" />
                    <input type="text" name="telf_bitel" placeholder="BITEL" class="input input-bordered input-xs" />
                    <input type="text" name="telf_wsp" placeholder="WSP" class="input input-bordered input-xs" />
                    <input type="text" name="telf_casa" placeholder="CASA" class="input input-bordered input-xs col-span-5" />
                </div>
             </div>
          </div>
          <div class="p-2 rounded-lg border border-error/30 bg-error/5 mt-2">
            <p class="text-[9px] font-black text-error mb-2 uppercase">REASIGNADO / CAMBIADO</p>
            <div class="grid grid-cols-4 gap-1">
                <input type="text" name="reasig_tipo_doc" placeholder="TIPO DOC" class="input input-bordered input-xs" />
                <input type="text" name="reasig_num" placeholder="N°" class="input input-bordered input-xs" />
                <input type="text" name="reasig_procedencia" placeholder="PROCEDENCIA" class="input input-bordered input-xs" />
                <input type="date" name="reasig_fecha" title="FECHA" class="input input-bordered input-xs" />
            </div>
          </div>
        </div>

      </div>

      <div class="modal-action sticky bottom-0 bg-base-200 py-4 border-t border-white/10 mt-6 flex  z-20">
        <button type="button" class="btn btn-error btn-outline btn-sm" onclick="add_modal.close()">DESCARTAR</button>
        <button type="submit" class="btn btn-success text-white btn-sm px-10">GUARDAR REGISTRO</button>
      </div>
    </form>
  </div>
  <!--Funcionalidad ESCAPE-->
  <!-- <form class="modal-backdrop backdrop-blur-md">
    <button type="button" onclick="add_modal.close()">close</button>
  </form> -->
</dialog>

<style>
  input {
    margin-top: 2px;
  }
</style>

<script>
  const inputIngreso = document.querySelector('[name="ingreso_pnp"]') as HTMLInputElement;
  const inputEgreso = document.querySelector('[name="egreso_pnp"]') as HTMLInputElement;
  
  const camposTiempo = [
    document.querySelector('[name="tiempo_servicio_anios"]') as HTMLInputElement,
    document.querySelector('[name="tiempo_servicio_meses"]') as HTMLInputElement,
    document.querySelector('[name="tiempo_servicio_dias"]') as HTMLInputElement
  ];

  function actualizarTiempoServicio() {
    const fInicio = inputIngreso?.value;
    const fFin = inputEgreso?.value;

    // Solo calculamos si AMBAS fechas están presentes
    if (!fInicio || !fFin) {
      camposTiempo.forEach(c => {
        if (c) {
          c.value = "";
          c.classList.add('opacity-50');
        }
      });
      return;
    }

    const inicio = new Date(fInicio);
    const fin = new Date(fFin);

    if (fin < inicio) {
        console.warn("Fecha de egreso inválida");
        return;
    }

    // Lógica de resta de fechas
    let anios = fin.getFullYear() - inicio.getFullYear();
    let meses = fin.getMonth() - inicio.getMonth();
    let dias = fin.getDate() - inicio.getDate();

    if (dias < 0) {
      meses--;
      const ultimoDiaMesPasado = new Date(fin.getFullYear(), fin.getMonth(), 0).getDate();
      dias += ultimoDiaMesPasado;
    }

    if (meses < 0) {
      anios--;
      meses += 12;
    }

    // Asignar valores y quitar opacidad
    camposTiempo[0].value = anios.toString();
    camposTiempo[1].value = meses.toString();
    camposTiempo[2].value = dias.toString();
    
    /* camposTiempo.forEach(c => c?.classList.remove('opacity-50')); */
  }

  inputIngreso?.addEventListener('change', actualizarTiempoServicio);
  inputEgreso?.addEventListener('change', actualizarTiempoServicio);
</script>

<script>
  import { personalSchema } from "@/lib/schemas/personal";

  const form = document.getElementById('form_personal') as HTMLFormElement;
  const modal = document.getElementById('add_modal') as HTMLDialogElement;
  const submitBtn = form?.querySelector('button[type="submit"]');
  const modalPreview = document.getElementById('modal_preview_foto') as HTMLImageElement;

  // Esto detiene el cierre automático del navegador
  window.addEventListener('keydown', (event) => {
    // Solo actuamos si la modal está abierta y se presiona Escape
    if (event.key === 'Escape' && modal?.open) {
      // 1. Prevenir que la modal se cierre
      event.preventDefault();
      event.stopImmediatePropagation();

      const activeElement = document.activeElement as HTMLInputElement;

      const isInput = activeElement && (activeElement.tagName === 'INPUT');

      if (isInput) {
        activeElement.value = "";
      }
    }
  }, true);

  // --- A. LÓGICA DE ENVÍO (POST / PUT) ---
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const mode = form.getAttribute('data-mode');
    const id = form.getAttribute('data-id');

    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    try {
      personalSchema.parse(data);

      // Decidimos URL y Método según el modo
      const url = mode === 'edit' ? `/api/personal/${id}` : '/api/personal';
      const method = mode === 'edit' ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method: method,
        body: formData,
      });

      if (response.ok) {
        alert(mode === 'edit' ? "¡Registro actualizado con éxito!" : "¡Registro guardado!");
        window.location.reload();
      } else {
        const result = await response.json();
        alert(`Error: ${result.error}`);
      }
    } catch (error: any) {
      if (error.errors) {
        const messages = error.errors.map((err: any) => err.message).join("\n");
        alert(`Validación fallida:\n${messages}`);
      } else {
        alert("Ocurrió un error inesperado.");
      }
    }
  });

  // --- B. LÓGICA DE ESCUCHA PARA EDITAR ---
  window.addEventListener('abrir-editar-personal', async (e: any) => {
    const id = e.detail.id;
    if (!form || !modal) return;

    form.reset();

    try {
      const response = await fetch(`/api/personal/${id}`);
      const data = await response.json();

      const fill = (obj: any) => {
        if (!obj) return;
        Object.entries(obj).forEach(([key, value]) => {
          const input = form.querySelector(`[name="${key}"]`) as HTMLInputElement;
          if (input) {
            if (input.type === 'file') return; // Saltamos el input de archivo
            input.value = (value !== null && value !== undefined) ? String(value) : "";
          }
        });
      };

      fill(data.Personal);
      fill(data.InfoPNP);
      fill(data.VidaSocial);

      // Lógica de la foto
      if (modalPreview) {
        if (data.Personal.foto && data.Personal.foto !== "--") {
          modalPreview.src = data.Personal.foto;
          modalPreview.classList.remove('hidden');
        } else {
          modalPreview.classList.add('hidden');
        }
      }

      // Cambiamos a MODO EDICIÓN
      form.setAttribute('data-mode', 'edit');
      form.setAttribute('data-id', id);
      if (submitBtn) submitBtn.textContent = "ACTUALIZAR REGISTRO";
      const title = modal.querySelector('h3');
      if (title) title.textContent = "✏️ EDITANDO REGISTRO DE PERSONAL";

      modal.showModal();
    } catch (error) {
      console.error("Error:", error);
    }
  });

  // --- C. FUNCIÓN DE LIMPIEZA (La que no veías) ---
  (window as any).prepararNuevoRegistro = () => {
    if (!form) return;
    form.reset();
    form.removeAttribute('data-mode');
    form.removeAttribute('data-id');

    if (modalPreview) {
      modalPreview.src = "";
      modalPreview.classList.add('hidden');
    }

    if (submitBtn) submitBtn.textContent = "GUARDAR REGISTRO";
    const title = modal?.querySelector('h3');
    if (title) title.textContent = "Ficha Integral de Registro de Personal";
  };
</script>
