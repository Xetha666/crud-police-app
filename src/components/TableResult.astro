---
import { Armamento, db, eq, InfoPNP, Personal, VidaSocial} from 'astro:db';

// Realizamos el JOIN para traer Identidad, Info Laboral y Vida Social
// El armamento lo manejaremos aparte por ser 1:N
const allPersonal = await db.select()
  .from(Personal)
  .innerJoin(InfoPNP, eq(Personal.id, InfoPNP.personal_id))
  .innerJoin(VidaSocial, eq(Personal.id, VidaSocial.personal_id));

// Traemos todo el armamento para mapearlo despu√©s
const listOfWeapons = await db.select().from(Armamento);
---

<div class="p-4">
  <div class="overflow-x-auto rounded-box border border-white bg-base-200 print:rounded-none">
    <table class="table table-lg w-full animate-blurred-fade-in">

      <thead class="select-none">
        <tr class="bg-base-200 text-center text-base *:border *:border-white">
          <th rowspan="5">#</th>
          <th rowspan="5" class="print:hidden">ACCIONES</th>
          <th rowspan="5" class="col-foto">FOTO</th>
          <th rowspan="5" class="col-sub-unidad">
            <div class="flex flex-col items-center justify-center text-center">
            <span>SUB UNIDAD</span>
            <span>Y/O</span>
            <span>SITUACI√ìN</span>
          </div>
          </th>
          <th rowspan="5" class="col-sede-depincri">
            <div class="flex flex-col items-center justify-center text-center">
              <span>SEDE</span>
              <span>DEPINCRI</span>
            </div>
          </th>
          <th rowspan="5" class="col-area-oficina">
            <div class="flex flex-col items-center justify-center text-center">
              <span>AREA</span>
              <span>Y/O</span>
              <span>OFICINA</span>
            </div>
          </th>
          <th rowspan="5" class="col-grado">GRADO</th>
          <th rowspan="5" class="col-apellidos-nombres">APELLIDOS Y NOMBRES</th>
          <th colspan="3" class="col-naturaleza">NATURALEZA</th>
          <th rowspan="5" class="col-fecha-nac">FECHA NACIMIEN.</th>
          <th rowspan="5" class="col-edad">EDAD</th>
          <th rowspan="5" class="col-dni">DNI</th>
          <th rowspan="5" class="col-codigo-dni">CODIGO DNI</th>
          <th rowspan="5" class="col-ingreso-pnp">INGRESO PNP</th>
          <th rowspan="5" class="col-egreso-pnp">EGRESO PNP</th>
          <th colspan="3" class="col-tiempo-servicio">TIEMPO DE SERVICIOS (Reales y Efectivos)</th>
          <th rowspan="5" class="col-codigo-especialidad">CODIGO y/o ESPECIALIDAD</th>
          <th colspan="4" class="col-cip">CARNET DE IDENTIDAD PERSONAL (CIP)</th>
          <th rowspan="5" class="col-ultimo-ascenso">ULTIMO ASCENSO</th>
          <th rowspan="5" class="col-incorp-divpol-chyo">INCORP. DIVPOL-CHYO</th>
          <th rowspan="5" class="col-grupo-sanguineo">GRUPO SANG.</th>
          <th rowspan="5" class="col-incorp-depincri">INCORP. DEPINCRI</th>
          <th rowspan="5" class="col-cargo">CARGO</th>
          <th rowspan="5" class="col-codigo-cargo">CODIGO CARGO</th>
          <th rowspan="5" class="col-funcion-horario">FUNCION Y HORARIO</th>
          <th rowspan="5" class="col-aptitud-psicosomatica">APTITUD PSICOSOMATICA</th>
          <th rowspan="5" class="col-procedencia">PROCEDENCIA</th>
          <th rowspan="5" class="col-incorp-depincri-calidad">SE INCORPORA AL DEPINCRI EN CALIDAD DE</th>
          <th colspan="24" class="col-armamento">ARMAMENTO DE USO PARTICULAR Y/O DE EL ESTADO</th>
          <th colspan="14" class="col-licencia-conducir" id="header-licencias-main">LICENCIA DE CONDUCIR</th>
          <th rowspan="5" class="col-ec">EC</th>
          <th colspan="5" class="col-domicilio">DOMICILIO</th>            
          <th colspan="2" class="col-banco-de-la-nacion">BANCO DE LA NACION</th>
          <th colspan="3" class="col-correo-electronico">CORREO ELECTRONICO</th>
          <th colspan="6" class="col-telefonos">TELEFONOS</th>
          <th colspan="4" class="col-cambiado-reasignado">CAMBIADO Y/O REASIGNADO A OTRA SUB UNIDAD PNP</th>
        </tr>

        <tr class="bg-base-200 text-center *:border *:border-white">
          <th rowspan="4" class="col-naturaleza">DISTRITO</th>
          <th rowspan="4" class="col-naturaleza">PROVINCIA</th>
          <th rowspan="4" class="col-naturaleza">DEPTO</th>
          <th rowspan="4" class="col-tiempo-servicio">A√ëOS</th>
          <th rowspan="4" class="col-tiempo-servicio">MESES</th>
          <th rowspan="4" class="col-tiempo-servicio">DIAS</th>
          <th rowspan="4" class="col-cip">ANTIGUO y/o CODOF√çN</th>
          <th rowspan="4" class="col-cip">CIP</th>
          <th rowspan="4" class="col-cip">SIT CIP</th>
          <th rowspan="4" class="col-cip">FECHA (Expedicion y/o P√©rdida)</th>
          <th colspan="12" class="col-armamento-part-group">PARTICULAR</th>            
          <th colspan="12" class="col-armamento-est-group">ESTADO</th>
          <th colspan="7" id="group-lic-mayor" class="col-lic-mayor-group">VEHICULO MAYOR (CAMIONETA Y/O AUTO)</th>            
          <th colspan="7" id="group-lic-menor" class="col-lic-menor-group">VEH√çCULO MENOR (MOTOCICLETA)</th>            
          <th rowspan="4" class="col-domicilio">DIRRECION</th>
          <th rowspan="4" class="col-domicilio">REFERENCIA DOMICILIARIA</th>
          <th rowspan="4" class="col-domicilio">DISTRITO</th>
          <th rowspan="4" class="col-domicilio">PROVINCIA</th>
          <th rowspan="4" class="col-domicilio">DEPTO</th>
          <th rowspan="4" class="col-banco-de-la-nacion">N¬∞ CUENTA AHORROS</th>
          <th rowspan="4" class="col-banco-de-la-nacion">C.C.I</th>
          <th colspan="2" class="col-correo-electronico">PARTICULAR</th>
          <th rowspan="4" class="col-correo-electronico">INSTITUCIONAL</th>
          <th rowspan="4" class="col-telefonos">CASA</th>
          <th colspan="5" class="col-telefonos">CELULAR</th>
          <th colspan="4" class="col-cambiado-reasignado">DOCUMENTO</th>

        </tr>

        <tr class="bg-base-200 text-center *:border *:border-white">
          <th rowspan="3" class="col-arma-particular">TIPO</th>
          <th rowspan="3" class="col-arma-particular">MARCA</th>
          <th rowspan="3" class="col-arma-particular">MODELO</th>
          <th rowspan="3" class="col-arma-particular">CALIBRE</th>
          <th rowspan="3" class="col-arma-particular">N¬∞ SERIE</th>
          <th colspan="5" class="col-arma-particular">CERTIFICADO DE ARMA DE FUEGO (CAF)</th>
          <th colspan="2" class="col-arma-particular">TARJETA DE PROPIEDAD ARMA DE FUEGO</th>
          <th rowspan="3" class="col-arma-estado">TIPO</th>
          <th rowspan="3" class="col-arma-estado">MARCA</th>
          <th rowspan="3" class="col-arma-estado">MODELO</th>
          <th rowspan="3" class="col-arma-estado">CALIBRE</th>
          <th rowspan="3" class="col-arma-estado">N¬∞ SERIE</th>
          <th colspan="5" class="col-arma-estado">CERTIFICADO DE ARMA DE FUEGO (CAF)</th>
          <th colspan="2" class="col-arma-estado">TARJETA DE PROPIEDAD ARMA DE FUEGO</th>
          <th rowspan="3" class="col-lic-mayor">PARTICULAR</th>
          <th rowspan="3" class="col-lic-mayor">POLICIAL</th>
          <th rowspan="3" class="col-lic-mayor">MILITAR</th>
          <th rowspan="3" class="col-lic-mayor">CLASE</th>
          <th rowspan="3" class="col-lic-mayor">CATEGORIA</th>
          <th rowspan="3" class="col-lic-mayor">F.EXPED.</th>
          <th rowspan="3" class="col-lic-mayor">F.CADUC.</th>
          <th rowspan="3" class="col-lic-menor">PARTICULAR</th>
          <th rowspan="3" class="col-lic-menor">POLICIAL</th>
          <th rowspan="3" class="col-lic-menor">MILITAR</th>
          <th rowspan="3" class="col-lic-menor">CLASE</th>
          <th rowspan="3" class="col-lic-menor">CATEGORIA</th>
          <th rowspan="3" class="col-lic-menor">F.EXPED.</th>
          <th rowspan="3" class="col-lic-menor">F.CADUC.</th>
          <th rowspan="3" class="col-correo-electronico">GMAIL</th>
          <th rowspan="3" class="col-correo-electronico">HOTMAIL</th>
          <th rowspan="3" class="col-telefonos">RPC</th>
          <th rowspan="3" class="col-telefonos">MOV-RPC</th>
          <th rowspan="3" class="col-telefonos">ENTEL</th>
          <th rowspan="3" class="col-telefonos">BITEL</th>
          <th rowspan="3" class="col-telefonos">WHATSAPP</th>
          <th rowspan="3" class="col-cambiado-reasignado">TIPO</th>
          <th rowspan="3" class="col-cambiado-reasignado">N¬∞</th>
          <th rowspan="3" class="col-cambiado-reasignado">PROCEDENCIA</th>
          <th rowspan="3" class="col-cambiado-reasignado">FECHA</th>
        </tr>

        <tr class="bg-base-200 text-center *:border *:border-white">
          <th rowspan="2" class="col-arma-particular">N¬∞ CAF</th>
          <th colspan="2" class="col-arma-particular">FECHA</th>
          <th rowspan="2" class="col-arma-particular">LIBRO</th>
          <th rowspan="2" class="col-arma-particular">FOLIO</th>
          <th rowspan="2" class="col-arma-particular">N¬∞</th>
          <th rowspan="2" class="col-arma-particular">FECHA EMISI√ìN</th>
          <th rowspan="2" class="col-arma-estado">N¬∞ CAF</th>
          <th colspan="2" class="col-arma-estado">FECHA</th>
          <th rowspan="2" class="col-arma-estado">LIBRO</th>
          <th rowspan="2" class="col-arma-estado">FOLIO</th>
          <th rowspan="2" class="col-arma-estado">N¬∞</th>
          <th rowspan="2" class="col-arma-estado">FECHA EMISI√ìN</th>
        </tr>

        <tr class="bg-base-200 text-center *:border *:border-white">
          <th class="col-arma-particular">EXPEDIC.</th>
          <th class="col-arma-particular">CADUCA</th>
          <th class="col-arma-estado">EXPEDIC.</th>
          <th class="col-arma-estado">CADUCA</th>
        </tr>
      </thead>

      <tbody class="select-none">
        {allPersonal.map(({ Personal: p, InfoPNP: i, VidaSocial: v }, index) => {
          // Buscamos las armas asociadas a esta persona
          const weaponPart = listOfWeapons.find(w => w.personal_id === p.id && w.tipo_procedencia === 'PARTICULAR');
          const weaponEst = listOfWeapons.find(w => w.personal_id === p.id && w.tipo_procedencia === 'ESTADO');

          return (
            <tr class="hover:bg-base-300/50 transition-colors text-center text-xs *:border *:border-gray-500">
              <th>{index + 1}</th>
              <td class="print:hidden p-0">
                <div class="inline-flex items-center justify-center gap-1 h-full w-full py-1">
                  <button value={p.id} class="btn btn-square text-2xl btn-info btn-xs btn-edit-personal" title="Editar">‚úèÔ∏è</button>
                  <button value={p.id} name={p.apellidos_nombres} class="btn btn-square text-2xl btn-error btn-xs btn-delete-personal" title="Eliminar">üóëÔ∏è</button>
                </div>
              </td>

              <td class="col-foto p-0">
                <div class="flex items-center justify-center h-full w-full">
                  <div class="avatar">
                    <div class="block">
                      <button class="cursor-pointer hover:scale-105 transition-transform p-3">
                        {p.foto !== "--" ? (
                          <a href={p.foto} title="Ver Foto Completa" target="_blank" rel="noopener noreferrer">
                            <img
                            id="preview_foto" 
                            src={p.foto} 
                            alt="Avatar" 
                            class="w-full h-full rounded-xl" 
                          />
                          </a>
                        ) : (
                          <span class="text-sm font-bold text-error leading-none text-center">
                            NO<br/>FOTO
                          </span>
                        )}
                      </button>
                    </div>
                  </div>
                </div>
              </td>

              {/* Datos Laborales e Identidad */}
              <td class="col-sub-unidad">{i.sub_unidad_situacion}</td>
              <td class="col-sede-depincri">{i.sede_depincri}</td>
              <td class="col-area-oficina">{i.area_oficina}</td>
              <td class="col-grado">{p.grado}</td>
              <td class=" col-apellidos-nombres font-bold uppercase">{p.apellidos_nombres}</td>
              <td class="col-naturaleza">{p.distrito_nac}</td>
              <td class="col-naturaleza">{p.provincia_nac}</td>
              <td class="col-naturaleza">{p.depto_nac}</td>
              <td class="col-fecha-nac">{p.fecha_nac}</td>
              <td class="col-edad">{p.edad}</td>
              <td class="col-dni">{p.dni}</td>
              <td class="col-codigo-dni">{p.codigo_dni}</td>
              <td class="col-ingreso-pnp">{i.ingreso_pnp}</td>
              <td class="col-egreso-pnp">{i.egreso_pnp}</td>
              <td class="col-tiempo-servicio">{i.tiempo_servicio_anios}</td>
              <td class="col-tiempo-servicio">{i.tiempo_servicio_meses}</td>
              <td class="col-tiempo-servicio">{i.tiempo_servicio_dias}</td>
              <td class="col-codigo-especialidad">{i.codigo_especialidad}</td>
              {/* CIP */}
              <td class="col-cip">{i.cip_antiguo_codofin}</td>
              <td class="col-cip">{i.cip_numero}</td>
              <td class="col-cip">{i.cip_situacion}</td>
              <td class="col-cip">{i.cip_fecha_expedicion}</td>

              {/* Mas Datos Laborales */}
              <td class="col-ultimo-ascenso">{i.ultimo_ascenso}</td>
              <td class="col-incorp-divpol-chyo">{i.incorp_divpol_chyo}</td>
              <td class="col-grupo-sanguineo">{i.grupo_sanguineo}</td>
              <td class="col-incorp-depincri">{i.incorp_depincri}</td>
              <td class="col-cargo">{i.cargo}</td>
              <td class="col-codigo-cargo">{i.codigo_cargo}</td>
              <td class="col-funcion-horario">{i.funcion_horario}</td>
              <td class="col-aptitud-psicosomatica">{i.aptitud_psicosomatica}</td>
              <td class="col-procedencia">{i.procedencia}</td>
              <td class="col-incorp-depincri-calidad">{i.calidad_incorporacion}</td>

              {/* ARMAMENTO PARTICULAR (12 columnas) */}
              <td class="col-arma-particular">{weaponPart?.tipo_arma}</td>
              <td class="col-arma-particular">{weaponPart?.marca}</td>
              <td class="col-arma-particular">{weaponPart?.modelo}</td>
              <td class="col-arma-particular">{weaponPart?.calibre}</td>
              <td class="col-arma-particular">{weaponPart?.serie}</td>
              <td class="col-arma-particular">{weaponPart?.caf_num}</td>
              <td class="col-arma-particular">{weaponPart?.caf_exped}</td>
              <td class="col-arma-particular">{weaponPart?.caf_caduca}</td>
              <td class="col-arma-particular">{weaponPart?.caf_libro}</td>
              <td class="col-arma-particular">{weaponPart?.caf_folio}</td>
              <td class="col-arma-particular">{weaponPart?.tarjeta_num}</td>
              <td class="col-arma-particular">{weaponPart?.tarjeta_emision}</td>

              {/* ARMAMENTO ESTADO (12 columnas) */}
              <td class="col-arma-estado">{weaponEst?.tipo_arma}</td>
              <td class="col-arma-estado">{weaponEst?.marca}</td>
              <td class="col-arma-estado">{weaponEst?.modelo}</td>
              <td class="col-arma-estado">{weaponEst?.calibre}</td>
              <td class="col-arma-estado">{weaponEst?.serie}</td>
              <td class="col-arma-estado">{weaponEst?.caf_num}</td>
              <td class="col-arma-estado">{weaponEst?.caf_exped}</td>
              <td class="col-arma-estado">{weaponEst?.caf_caduca}</td>
              <td class="col-arma-estado">{weaponEst?.caf_libro}</td>
              <td class="col-arma-estado">{weaponEst?.caf_folio}</td>
              <td class="col-arma-estado">{weaponEst?.tarjeta_num}</td>
              <td class="col-arma-estado">{weaponEst?.tarjeta_emision}</td>

              {/* LICENCIAS (Veh√≠culo Mayor) */}
              <td class="col-lic-mayor">{v.lic_mayor_particular}</td>
              <td class="col-lic-mayor">{v.lic_mayor_policial}</td>
              <td class="col-lic-mayor">{v.lic_mayor_militar}</td>
              <td class="col-lic-mayor">{v.lic_mayor_clase}</td>
              <td class="col-lic-mayor">{v.lic_mayor_categoria}</td>
              <td class="col-lic-mayor">{v.lic_mayor_f_exped}</td>
              <td class="col-lic-mayor">{v.lic_mayor_f_caduc}</td>

              {/* LICENCIAS (Veh√≠culo Menor) */}
              <td class="col-lic-menor">{v.lic_menor_particular}</td>
              <td class="col-lic-menor">{v.lic_menor_policial}</td>
              <td class="col-lic-menor">{v.lic_menor_militar}</td>
              <td class="col-lic-menor">{v.lic_menor_clase}</td>
              <td class="col-lic-menor">{v.lic_menor_categoria}</td>
              <td class="col-lic-menor">{v.lic_menor_f_exped}</td>
              <td class="col-lic-menor">{v.lic_menor_f_caduc}</td>

              {/* ESTADO CIVIL Y DOMICILIO */}
              <td class="col-ec">{v.estado_civil}</td>
              <td class="col-domicilio">{v.direccion}</td>
              <td class="col-domicilio">{v.referencia_domiciliaria}</td>
              <td class="col-domicilio">{v.distrito_dom}</td>
              <td class="col-domicilio">{v.provincia_dom}</td>
              <td class="col-domicilio">{v.depto_dom}</td>

              {/* BANCO DE LA NACI√ìN */}
              <td class="col-banco-de-la-nacion">{v.bn_cuenta_corriente}</td>
              <td class="col-banco-de-la-nacion">{v.bn_cci}</td>

              {/* CORREOS */}
              <td class="col-correo-electronico">{v.email_gmail}</td>
              <td class="col-correo-electronico">{v.email_hotmail}</td>
              <td class="col-correo-electronico">{v.email_institucional}</td>

              {/* TEL√âFONOS */}
              <td class="col-telefonos">{v.telf_casa}</td>
              <td class="col-telefonos">{v.telf_rpc}</td>
              <td class="col-telefonos">{v.telf_rpm}</td>
              <td class="col-telefonos">{v.telf_entel}</td>
              <td class="col-telefonos">{v.telf_bitel}</td>
              <td class="col-telefonos">{v.telf_wsp}</td>

              {/* REASIGNACI√ìN */}
              <td class="col-cambiado-reasignado">{v.reasig_tipo_doc}</td>
              <td class="col-cambiado-reasignado">{v.reasig_num}</td>
              <td class="col-cambiado-reasignado">{v.reasig_procedencia}</td>
              <td class="col-cambiado-reasignado">{v.reasig_fecha}</td>
            </tr>
          );
          
        })}
      </tbody>

    </table>
  </div>
</div>

<!--DELETE-->
<script>
    const deleteButtons = document.querySelectorAll('.btn-delete-personal');

    deleteButtons.forEach((button) => {
      button.addEventListener('click', async (e) => {
        const btn = e.currentTarget as HTMLButtonElement;
        if (!btn) return;
        const id = btn.value;
        const nombre = btn.name;

        if (!id) return;
        
        if (!confirm('¬øEst√°s seguro de eliminar a ' + nombre + '? Esta acci√≥n es irreversible.')) return;

        try {
          const response = await fetch('/api/personal/' + id, {
            method: 'DELETE'
          });

          if (response.ok) {
            window.location.reload();
          } else {
            const data = await response.json();
            alert('Error: ' + (data.error || 'No se pudo eliminar'));
          }
        } catch (err) {
          alert('Ocurri√≥ un error al intentar conectar con el servidor.');
        }
      });
    });
</script>

<!--Disparador de Evento para el EDIT -->
<script>
  document.addEventListener('click', (e) => {
    const target = e.target;
    if (!(target instanceof HTMLElement)) return;
    const btn = target.closest('.btn-edit-personal') as HTMLButtonElement;

    if (!btn) return;
      const id = btn.value;

      // Lanzamos un evento personalizado que AddButton escuchar√°
      const editEvent = new CustomEvent('abrir-editar-personal', {
        detail: { id }
      });

      window.dispatchEvent(editEvent);
    }
  );
</script>